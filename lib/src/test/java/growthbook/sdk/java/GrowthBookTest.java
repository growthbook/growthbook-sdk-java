/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package growthbook.sdk.java;

import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.reflect.TypeToken;
import growthbook.sdk.java.testhelpers.PaperCupsConfig;
import growthbook.sdk.java.testhelpers.TestCasesJsonHelper;
import growthbook.sdk.java.testhelpers.TestContext;
import org.junit.jupiter.api.Test;

import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Objects;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class GrowthBookTest {

    final TestCasesJsonHelper helper = TestCasesJsonHelper.getInstance();
    final GrowthBookJsonUtils jsonUtils = GrowthBookJsonUtils.getInstance();

    @Test
    void test_evalFeature() {
        JsonArray testCases = helper.featureTestCases();

        ArrayList<String> passedTests = new ArrayList<>();
        ArrayList<String> failedTests = new ArrayList<>();
        ArrayList<Integer> failingIndexes = new ArrayList<>();

        for (int i = 0; i < testCases.size(); i++) {
            JsonObject testCase = (JsonObject) testCases.get(i);
            String testDescription = testCase.get("name").getAsString();

            String featuresJson = testCase.get("context").getAsJsonObject().get("features").getAsString();

            String attributesJson = testCase.get("context").getAsJsonObject().get("attributes").getAsString();

            Type forcedVariationsType = new TypeToken<HashMap<String, Integer>>() {}.getType();
            HashMap<String, Integer> forcedVariations = jsonUtils.gson.fromJson(testCase.get("context").getAsJsonObject().get("forcedVariations"), forcedVariationsType);

//            System.out.println("\n\n--------------------------");
//            System.out.printf("evalFeature test: %s (index = %s)", testDescription, i);
//            System.out.printf("\n features: %s", featuresJson);
//            System.out.printf("\n attributesJson: %s", attributesJson);

            GBContext context = GBContext
                    .builder()
                    .featuresJson(featuresJson)
                    .attributesJson(attributesJson)
                    .forcedVariationsMap(forcedVariations)
                    .build();

//            System.out.printf("\n context: %s", context);
            String featureKey = testCase.get("feature").getAsString();
//            String type = testCase.get("type").getAsString();

            GrowthBook subject = new GrowthBook(context);
            String expectedString = testCase.get("result").getAsString();
            FeatureResult expectedResult = jsonUtils.gson.fromJson(expectedString, FeatureResult.class);

            FeatureResult<Object> result = subject.evalFeature(featureKey);
//            System.out.printf("\n\n Eval Feature result: %s - JSON: %s", result, result.toJson());

            boolean passes = expectedResult.equals(result);

            if (passes) {
                passedTests.add(testDescription);
            } else {
                System.out.printf("\n\nExpected result = %s", expectedResult);
                System.out.printf("\n  Actual result = %s", result);

                failedTests.add(testDescription);
                failingIndexes.add(i);
            }
        }

        System.out.printf("\n\n✅ evalFeature - Passed tests: %s", passedTests);
        System.out.printf("\n\n\n❗️ evalFeature - Failed tests = %s / %s . Failing = %s", failedTests.size(), testCases.size(), failedTests);
        System.out.printf("\n\n\n evalFeature - Failing indexes = %s", failingIndexes);

        assertEquals(0, failedTests.size(), "There are failing tests");
    }

    @Test
    void run_executesExperimentResultCallbacks() {
        GrowthBook subject = new GrowthBook();
        ExperimentRunCallback mockCallback1 = mock(ExperimentRunCallback.class);
        ExperimentRunCallback mockCallback2 = mock(ExperimentRunCallback.class);
        Experiment<String> mockExperiment = Experiment.<String>builder().build();

        subject.subscribe(mockCallback1);
        subject.subscribe(mockCallback2);
        ExperimentResult<String> result = subject.run(mockExperiment);

        verify(mockCallback1).onRun(result);
        verify(mockCallback2).onRun(result);
    }

    @Test
    void run_executesExperimentResultCallbacksEveryTimeItIsCalled() {
        GrowthBook subject = new GrowthBook();
        ExperimentRunCallback mockCallback = mock(ExperimentRunCallback.class);
        Experiment<String> mockExperiment = Experiment.<String>builder().build();

        subject.subscribe(mockCallback);
        subject.run(mockExperiment);
        subject.run(mockExperiment);
        subject.run(mockExperiment);

        verify(mockCallback, times(3)).onRun(any());
    }

    @Test
    void test_runExperiment() {
        JsonArray testCases = helper.runTestCases();

        ArrayList<String> passedTests = new ArrayList<>();
        ArrayList<String> failedTests = new ArrayList<>();
        ArrayList<Integer> failingIndexes = new ArrayList<>();

        for (int i = 0; i < testCases.size(); i++) {
            JsonObject testCase = (JsonObject) testCases.get(i);
            String testDescription = testCase.get("name").getAsString();

            TestContext testContext = jsonUtils.gson.fromJson(testCase.get("context").getAsJsonObject(), TestContext.class);

            GBContext context = GBContext
                    .builder()
                    .featuresJson(testContext.features)
                    .attributesJson(testContext.attributes)
                    .forcedVariationsMap(testContext.forcedVariations)
                    .isQaMode(testContext.qaMode)
                    .enabled(testContext.enabled)
                    .url(testContext.url)
                    .build();

            Experiment experiment = jsonUtils.gson.fromJson(testCase.get("experiment").getAsString(), Experiment.class);
            ExperimentResult expectedResult = jsonUtils.gson.fromJson(testCase.get("result"), ExperimentResult.class);
            JsonElement experimentElement = jsonUtils.gson.fromJson(testCase.get("experiment"), JsonElement.class);
            if (experimentElement != null) {
//                System.out.printf("\n\n HERE: Experiment %s (index = %s)", experiment, i);
                JsonObject experimentObject = jsonUtils.gson.fromJson(experimentElement.getAsString(), JsonObject.class);
                JsonElement conditionElement = experimentObject.get("condition");
                if (conditionElement != null) {
                    String conditionJson = conditionElement.toString();
                    experiment.setConditionJson(conditionJson);
                }
            }

            GrowthBook subject = new GrowthBook(context);
            ExperimentResult result = subject.run(experiment);

            boolean valueMatches = Objects.equals(result.getValue(), expectedResult.getValue());
            boolean inExperimentMatches = Objects.equals(result.getInExperiment(), expectedResult.getInExperiment());
            boolean hashUsed = Objects.equals(result.getHashUsed(), expectedResult.getHashUsed());

            boolean passes = valueMatches && inExperimentMatches && hashUsed;

            if (passes) {
                passedTests.add(testDescription);
            } else {
                System.out.println("-----");
                System.out.printf("\n\n Test %s - (index = %s) Testing with context: %s", testDescription, i, context);
                System.out.printf("\n\n Experiment: %s", experiment);

                System.out.printf("\n\nExpected result = %s", expectedResult);
                System.out.printf("\n  Actual result = %s", result);

                failedTests.add(testDescription);
                failingIndexes.add(i);
            }
        }

        System.out.printf("\n\n✅ run Experiment - Passed tests: %s", passedTests);
        System.out.printf("\n\n\n❗️ run Experiment - Failed tests = %s / %s . Failing = %s", failedTests.size(), testCases.size(), failedTests);
        System.out.printf("\n\n\n run Experiment - Failing indexes = %s", failingIndexes);

        assertEquals(0, failedTests.size(), "There are failing tests");
    }

    @Test
    void test_isOn_returns_true() {
        String featureKey = "new-feature";
        String attributes = "{ \"user_group\": \"subscriber\", \"beta_users\": true }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        assertTrue(subject.isOn(featureKey));
        assertFalse(subject.isOff(featureKey));
    }

    @Test
    void test_isOn_returns_false() {
        String featureKey = "new-feature";
        String attributes = "{ \"user_group\": \"standard\", \"beta_users\": false }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        assertFalse(subject.isOn(featureKey));
        assertTrue(subject.isOff(featureKey));
    }

    @Test
    void test_getFeatureValue_boolean() {
        String featureKey = "new-feature";
        String attributes = "{ \"user_group\": \"subscriber\", \"beta_users\": true }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue(featureKey, false);

        assertTrue(result);
    }

    @Test
    void test_getFeatureValue_string_inExperiment() {
        String featureKey = "covid-banner-text";
        String attributes = "{ \"user_group\": \"subscriber\", \"beta_users\": true }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        String result = subject.getFeatureValue(featureKey, "nope");

        assertEquals("Beta users", result);
    }

    @Test
    void test_getFeatureValue_string_notInExperiment() {
        String featureKey = "covid-banner-text";
        String attributes = "{ \"user_group\": \"subscriber\", \"beta_users\": false }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        String result = subject.getFeatureValue(featureKey, "nope");

        assertEquals("We're safe", result);
    }

    @Test
    void test_getFeatureValue_double_inExperiment() {
        String featureKey = "demo";
        String attributes = "{ \"admin\": true }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Double result = subject.getFeatureValue(featureKey, Double.valueOf(999));

        assertEquals(1, result);
    }

    @Test
    void test_getFeatureValue_integer_inExperiment() {
        String featureKey = "demo";
        String attributes = "{ \"admin\": true }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Integer result = subject.getFeatureValue(featureKey, 999);

        assertEquals(1, result);
    }

    @Test
    void test_getFeatureValue_float() {
        String featureKey = "price";
        String attributes = "{ \"user\": \"standard\" }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Float result = subject.getFeatureValue(featureKey, 0.00f);

        assertEquals(10.99f, result);
    }

    @Test
    void test_getFeatureValue_asObject() {
        String featureKey = "papercups-config";
        String attributes = "{ \"user\": \"standard\" }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Object defaultConfig = new PaperCupsConfig("abc123", "My Chat", true);
        Object resultObject = subject.getFeatureValue(featureKey, defaultConfig);
        // showing that this object can be deserialized manually
        String resultConfigString = jsonUtils.gson.toJson(resultObject);
        PaperCupsConfig resultConfig = jsonUtils.gson.fromJson(resultConfigString, PaperCupsConfig.class);

        assertNotNull(resultObject);
        assertNotNull(resultConfig);
        assertEquals("Welcome to GrowthBook Cloud", resultConfig.title);
    }

    @Test
    void test_getFeatureValue_asGsonDeserializable() {
        String featureKey = "papercups-config";
        String attributes = "{ \"user\": \"standard\" }";
        String features = TestCasesJsonHelper.getInstance().getDemoFeaturesJson();

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        PaperCupsConfig defaultConfig = new PaperCupsConfig("abc123", "My Chat", true);
        PaperCupsConfig resultConfig = subject.getFeatureValue(featureKey, defaultConfig, PaperCupsConfig.class);

        assertNotNull(resultConfig);
        assertEquals("Welcome to GrowthBook Cloud", resultConfig.title);
    }

    @Test
    void test_getFeatureValue_returnsFeatureValueFromEncryptedFeatures() {
        String encryptedFeaturesJson = "7rvPA94JEsqRo9yPZsdsXg==.bJ8vtYvX+ur3cEUFVkYo1OyWb98oLnMlpeoO0Hs4YPc0EVb7oKX4KNz+Yt6GUMBsieXqtL7oaYzX+kMayZEtV+3bhyDYnS9QBrvalnfxbLExjtnsy8g0pPQHU/P/DPIzO0F+pphcahRfi+3AMTnIreqvkqrcX+MyOwHN56lqEs23Vp4Rsq2qDow/LZmn5kpwMNhMY0DBq7jC+lh2Oyly0g==";
        String encryptionKey = "BhB1wORFmZLTDjbvstvS8w==";
        String sampleUserAttributes = "{\"country\": \"mexico\", \"device\": \"android\"}";

        GBContext context = GBContext
                .builder()
                .attributesJson(sampleUserAttributes)
                .featuresJson(encryptedFeaturesJson)
                .encryptionKey(encryptionKey)
                .build();
        GrowthBook subject = new GrowthBook(context);

        String result = subject.getFeatureValue("greeting", "hello");
        String expected = "hola";

        assertEquals(expected, result);
    }

    @Test
    void test_evaluateCondition_callsConditionEvaluator() {
        ConditionEvaluator mockConditionEvaluator = mock(ConditionEvaluator.class);
        ExperimentEvaluator mockExperimentEvaluator = mock(ExperimentEvaluator.class);
        FeatureEvaluator mockFeatureEvaluator = mock(FeatureEvaluator.class);
        GBContext context = GBContext.builder().build();

        String attrJson = "{ id: 1 }";
        String conditionJson = "{}";

        GrowthBook subject = new GrowthBook(context, mockFeatureEvaluator, mockConditionEvaluator, mockExperimentEvaluator);

        subject.evaluateCondition(attrJson, conditionJson);

        verify(mockConditionEvaluator).evaluateCondition(attrJson, conditionJson);
    }

    @Test
    void test_destroyClearsCallbacks() {
        GrowthBook subject = new GrowthBook();
        ExperimentRunCallback mockCallback1 = mock(ExperimentRunCallback.class);
        ExperimentRunCallback mockCallback2 = mock(ExperimentRunCallback.class);
        Experiment<String> mockExperiment = Experiment.<String>builder().build();

        // Add callbacks
        subject.subscribe(mockCallback1);
        subject.subscribe(mockCallback2);

        // Perform action that results in the initial call
        subject.run(mockExperiment);

        // Perform action that clears callbacks
        subject.destroy();

        // Run another experiment
        ExperimentResult<String> result2 = subject.run(mockExperiment);

        // Verify callbacks are only called once (for the initial invocation)
        verify(mockCallback1, times(1)).onRun(result2);
        verify(mockCallback2, times(1)).onRun(result2);
    }

    // region getFeatureValue

    @Test
    void test_getFeatureValue_string_nullValueUsesDefaultValue() {
        String featureKey = "some-unknown-feature-key";
        String features = "{}";
        String attributes = "{}";

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        String result = subject.getFeatureValue(featureKey, "my fallback value");

        assertNotNull(result);
        assertEquals("my fallback value", result);
    }

    @Test
    void test_getFeatureValue_float_nullValueUsesDefaultValue() {
        String featureKey = "some-unknown-feature-key";
        String features = "{}";
        String attributes = "{}";

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Float result = subject.getFeatureValue(featureKey, 10.0f);

        assertNotNull(result);
        assertEquals(10.0f, result);
    }

    @Test
    void test_getFeatureValue_integer_nullValueUsesDefaultValue() {
        String featureKey = "some-unknown-feature-key";
        String features = "{}";
        String attributes = "{}";

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Integer result = subject.getFeatureValue(featureKey, 99);

        assertNotNull(result);
        assertEquals(99, result);
    }

    @Test
    void test_getFeatureValue_double_nullValueUsesDefaultValue() {
        String featureKey = "some-unknown-feature-key";
        String features = "{}";
        String attributes = "{}";

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        Double result = subject.getFeatureValue(featureKey, Double.valueOf(101));

        assertNotNull(result);
        assertEquals(Double.valueOf(101), result);
    }

    @Test
    void test_getFeatureValue_gsonDeserializable_nullValueUsesDefaultValue() {
        String featureKey = "some-unknown-feature-key";
        String features = "{}";
        String attributes = "{}";

        GBContext context = GBContext
                .builder()
                .featuresJson(features)
                .attributesJson(attributes)
                .build();
        GrowthBook subject = new GrowthBook(context);

        PaperCupsConfig defaultConfig = new PaperCupsConfig("abc123", "My Chat", true);
        PaperCupsConfig result = subject.getFeatureValue(featureKey, defaultConfig, PaperCupsConfig.class);

        assertNotNull(result);
        assertEquals(defaultConfig, result);
    }

    // endregion getFeatureValue


    // region URL -> force features

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_true() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=true&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", false);

        assertEquals(true, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_on() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=on&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", false);

        assertEquals(true, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_1() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=1&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", false);

        assertEquals(true, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_false() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=false&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", true);

        assertEquals(false, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_off() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=off&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", true);

        assertEquals(false, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesBooleanValue_0() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=0&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Boolean result = subject.getFeatureValue("dark_mode", true);

        assertEquals(false, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesIntegerValue() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=true&donut_price=2&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";

        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Integer result = subject.getFeatureValue("donut_price", 999);

        assertEquals(2, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesFloatValue() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=true&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";
        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        Float result = subject.getFeatureValue("donut_price", 9999f);

        assertEquals(3.33f, result);
    }

    @Test
    void test_withUrl_getFeatureValue_forcesStringValue() {
        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
        String attributes = "{}";
        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=true&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";
        GBContext context = GBContext
            .builder()
            .featuresJson(featuresJson)
            .attributesJson(attributes)
            .url(url)
            .build();
        GrowthBook subject = new GrowthBook(context);

        String result = subject.getFeatureValue("banner_text", "???");
        assertEquals("Hello, everyone! I hope you are all doing well!", result);
    }

//    @Test
//    void test_withUrl_getFeatureValue_forcesJsonValue() {
//        String featuresJson = "{\"status\":200,\"features\":{\"banner_text\":{\"defaultValue\":\"Welcome to Acme Donuts!\",\"rules\":[{\"condition\":{\"country\":\"france\"},\"force\":\"Bienvenue au Beignets Acme !\"},{\"condition\":{\"country\":\"spain\"},\"force\":\"¡Bienvenidos y bienvenidas a Donas Acme!\"}]},\"dark_mode\":{\"defaultValue\":false,\"rules\":[{\"condition\":{\"loggedIn\":true},\"force\":true,\"coverage\":0.5,\"hashAttribute\":\"id\"}]},\"donut_price\":{\"defaultValue\":2.5,\"rules\":[{\"condition\":{\"employee\":true},\"force\":0}]},\"meal_overrides_gluten_free\":{\"defaultValue\":{\"meal_type\":\"standard\",\"dessert\":\"Strawberry Cheesecake\"},\"rules\":[{\"condition\":{\"dietaryRestrictions\":{\"$elemMatch\":{\"$eq\":\"gluten_free\"}}},\"force\":{\"meal_type\":\"gf\",\"dessert\":\"French Vanilla Ice Cream\"}}]}},\"dateUpdated\":\"2023-01-11T00:26:01.745Z\"}";
//        String attributes = "{}";
//        String url = "http://localhost:8080/url-feature-force?gb~meal_overrides_gluten_free=%7B%22gb~meal_type%22%3A%20%22gf%22%2C%20%22dessert%22%3A%20%22French%20Vanilla%20Ice%20Cream%22%7D&gb~dark_mode=true&donut_price=3.33&gb~banner_text=Hello%2C%20everyone!%20I%20hope%20you%20are%20all%20doing%20well!";
//
//    }

    // endregion URL -> force features
}
